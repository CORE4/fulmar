#!/usr/bin/env ruby

require 'fulmar_file_sync'
require 'yaml'
require 'pp'
require 'ruby_wings'

if !ARGV[0] or ARGV[0].empty? or !ARGV[1] or ARGV[1].empty?
  STDERR.puts 'Usage: deploy path/to/config_file.yml <environment>'
  exit 1
end

CONFIG_FILE = ARGV[0]
ENVIRONMENT = ARGV[1].to_sym

unless File.exists? CONFIG_FILE
  STDERR.puts 'Config file not found'
  exit 2
end

config = YAML.load_file(CONFIG_FILE).symbolize

unless config[:environments]
  STDERR.puts 'Cannot read environment config'
  exit 3
end

unless config[:environments][ENVIRONMENT]
  STDERR.puts "Environment #{ENVIRONMENT} not configured."
  exit 3
end

# Make sure a globally set vars get into the environment if not explicitly specified
global_vars = [:local_path, :debug]
global_vars.each do |key|
  if config[:environments][:all][key] and not config[:environments][ENVIRONMENT][key]
    config[:environments][ENVIRONMENT][key] = config[:environments][:all][key]
  end
end

#pp config['environments'][ENVIRONMENT]

deploy = Fulmar::FileSync.create_transfer(config[:environments][ENVIRONMENT])

puts "Deployed #{deploy.transfer}."
puts "Changes are #{deploy.publish ? '' : 'not '}live."